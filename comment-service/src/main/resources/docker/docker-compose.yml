version: '3.8'

services:
  postgres-audit-comments:
    image: postgres:15-alpine
    container_name: audit-comments-db
    environment:
      POSTGRES_DB: audit_comments_db
      POSTGRES_USER: audit_admin
      POSTGRES_PASSWORD: secret123
    ports:
      - "5433:5432"
    volumes:
      - postgres_audit_comments_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    networks:
      - audit-network

  nats-audit:
    image: nats:latest
    container_name: audit-nats
    ports:
      - "4222:4222"
      - "8222:8222"
    networks:
      - audit-network

  audit-comment-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: audit-comment-service
    ports:
      - "8082:8082"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-audit-comments:5432/audit_comments_db
      SPRING_DATASOURCE_USERNAME: audit_admin
      SPRING_DATASOURCE_PASSWORD: secret123
      NATS_SERVERS: nats://nats-audit:4222
      JWT_ISSUER_URI: http://auth-service:8081
      JWK_SET_URI: http://auth-service:8081/.well-known/jwks.json
    depends_on:
      - postgres-audit-comments
      - nats-audit
    networks:
      - audit-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/comment-service/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  audit-network:
    driver: bridge

volumes:
  postgres_audit_comments_data: